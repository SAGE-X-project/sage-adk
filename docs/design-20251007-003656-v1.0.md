# Error Type Definitions Design

**Version**: 1.0
**Created**: 2025-10-07 00:36:56
**Status**: Design Phase
**Target**: pkg/errors/

---

## Overview

This document defines a comprehensive error handling system for SAGE ADK. The error system must:

1. **Type-Safe**: Strong error types with clear categorization
2. **Contextual**: Rich error context for debugging
3. **Wrappable**: Support error wrapping per Go 1.13+ conventions
4. **User-Friendly**: Clear error messages for different audiences
5. **Structured**: Machine-readable error codes and metadata

---

## Design Principles

### 1. Error Categories

Organize errors into logical categories:

```go
type ErrorCategory string

const (
    CategoryValidation   ErrorCategory = "validation"
    CategoryProtocol     ErrorCategory = "protocol"
    CategorySecurity     ErrorCategory = "security"
    CategoryStorage      ErrorCategory = "storage"
    CategoryLLM          ErrorCategory = "llm"
    CategoryNetwork      ErrorCategory = "network"
    CategoryInternal     ErrorCategory = "internal"
    CategoryNotFound     ErrorCategory = "not_found"
    CategoryUnauthorized ErrorCategory = "unauthorized"
)
```

### 2. Base Error Type

```go
type Error struct {
    Category ErrorCategory
    Code     string
    Message  string
    Details  map[string]interface{}
    Err      error  // wrapped error
}
```

### 3. Error Interface Compliance

Implement standard Go error interfaces:
- `error` interface
- `Unwrap() error` for error wrapping (Go 1.13+)
- `Is(target error) bool` for error comparison
- `As(target interface{}) bool` for type assertion

---

## Error Definitions

### Validation Errors

```go
var (
    ErrInvalidInput = &Error{
        Category: CategoryValidation,
        Code:     "INVALID_INPUT",
        Message:  "invalid input provided",
    }

    ErrMissingField = &Error{
        Category: CategoryValidation,
        Code:     "MISSING_FIELD",
        Message:  "required field is missing",
    }

    ErrInvalidFormat = &Error{
        Category: CategoryValidation,
        Code:     "INVALID_FORMAT",
        Message:  "invalid format",
    }
)
```

### Protocol Errors

```go
var (
    ErrProtocolMismatch = &Error{
        Category: CategoryProtocol,
        Code:     "PROTOCOL_MISMATCH",
        Message:  "protocol mismatch",
    }

    ErrUnsupportedProtocol = &Error{
        Category: CategoryProtocol,
        Code:     "UNSUPPORTED_PROTOCOL",
        Message:  "protocol not supported",
    }

    ErrMessageParsing = &Error{
        Category: CategoryProtocol,
        Code:     "MESSAGE_PARSING_ERROR",
        Message:  "failed to parse message",
    }
)
```

### Security Errors

```go
var (
    ErrSignatureInvalid = &Error{
        Category: CategorySecurity,
        Code:     "INVALID_SIGNATURE",
        Message:  "signature verification failed",
    }

    ErrDIDNotFound = &Error{
        Category: CategorySecurity,
        Code:     "DID_NOT_FOUND",
        Message:  "DID not found in registry",
    }

    ErrAgentInactive = &Error{
        Category: CategorySecurity,
        Code:     "AGENT_INACTIVE",
        Message:  "agent is deactivated",
    }

    ErrUnauthorized = &Error{
        Category: CategoryUnauthorized,
        Code:     "UNAUTHORIZED",
        Message:  "unauthorized access",
    }
)
```

### Storage Errors

```go
var (
    ErrStorageNotFound = &Error{
        Category: CategoryNotFound,
        Code:     "NOT_FOUND",
        Message:  "resource not found in storage",
    }

    ErrStorageConnection = &Error{
        Category: CategoryStorage,
        Code:     "CONNECTION_ERROR",
        Message:  "storage connection failed",
    }

    ErrStorageTimeout = &Error{
        Category: CategoryStorage,
        Code:     "TIMEOUT",
        Message:  "storage operation timed out",
    }
)
```

### LLM Errors

```go
var (
    ErrLLMConnection = &Error{
        Category: CategoryLLM,
        Code:     "LLM_CONNECTION_ERROR",
        Message:  "failed to connect to LLM provider",
    }

    ErrLLMRateLimit = &Error{
        Category: CategoryLLM,
        Code:     "RATE_LIMIT_EXCEEDED",
        Message:  "LLM rate limit exceeded",
    }

    ErrLLMInvalidResponse = &Error{
        Category: CategoryLLM,
        Code:     "INVALID_RESPONSE",
        Message:  "invalid response from LLM",
    }
)
```

### Network Errors

```go
var (
    ErrNetworkTimeout = &Error{
        Category: CategoryNetwork,
        Code:     "NETWORK_TIMEOUT",
        Message:  "network request timed out",
    }

    ErrNetworkUnavailable = &Error{
        Category: CategoryNetwork,
        Code:     "NETWORK_UNAVAILABLE",
        Message:  "network unavailable",
    }
)
```

### Internal Errors

```go
var (
    ErrInternal = &Error{
        Category: CategoryInternal,
        Code:     "INTERNAL_ERROR",
        Message:  "internal server error",
    }

    ErrNotImplemented = &Error{
        Category: CategoryInternal,
        Code:     "NOT_IMPLEMENTED",
        Message:  "feature not implemented",
    }
)
```

---

## Error Methods

### Core Methods

```go
// Error implements the error interface
func (e *Error) Error() string

// Unwrap returns the wrapped error for Go 1.13+ error unwrapping
func (e *Error) Unwrap() error

// Is checks if the error matches the target error
func (e *Error) Is(target error) bool

// As checks if the error can be assigned to target
func (e *Error) As(target interface{}) bool

// WithMessage returns a new error with additional message
func (e *Error) WithMessage(msg string) *Error

// WithDetails returns a new error with additional details
func (e *Error) WithDetails(details map[string]interface{}) *Error

// WithDetail adds a single detail field
func (e *Error) WithDetail(key string, value interface{}) *Error

// Wrap wraps an existing error
func (e *Error) Wrap(err error) *Error
```

### Helper Functions

```go
// New creates a new Error with category and code
func New(category ErrorCategory, code, message string) *Error

// Wrap wraps an existing error with context
func Wrap(err error, message string) error

// Is checks if err matches target
func Is(err, target error) bool

// As finds the first error in err's chain that matches target
func As(err error, target interface{}) bool
```

---

## Usage Examples

### Creating Errors

```go
// Use predefined error
err := errors.ErrInvalidInput.WithDetail("field", "messageId")

// Create custom error
err := errors.New(
    errors.CategoryValidation,
    "CUSTOM_ERROR",
    "custom error message",
)
```

### Wrapping Errors

```go
// Wrap with context
if err := validateMessage(msg); err != nil {
    return errors.ErrInvalidInput.
        WithMessage("message validation failed").
        Wrap(err)
}

// Using Wrap helper
if err := storage.Save(data); err != nil {
    return errors.Wrap(err, "failed to save data")
}
```

### Error Checking

```go
// Check error type
if errors.Is(err, errors.ErrNotFound) {
    // handle not found
}

// Extract error details
var adkErr *errors.Error
if errors.As(err, &adkErr) {
    log.Printf("Error code: %s, details: %v", adkErr.Code, adkErr.Details)
}
```

---

## Testing Strategy

### Unit Tests

Test error creation, wrapping, and checking:

```go
func TestError_Creation(t *testing.T)
func TestError_Wrapping(t *testing.T)
func TestError_Is(t *testing.T)
func TestError_As(t *testing.T)
func TestError_WithDetails(t *testing.T)
func TestError_Error(t *testing.T)
```

### Coverage Goals

- 90%+ test coverage
- All error types tested
- All methods tested
- Error wrapping chains tested

---

## File Organization

```
pkg/errors/
├── doc.go           # Package documentation
├── errors.go        # Base Error type and methods
├── errors_test.go   # Base error tests
├── validation.go    # Validation errors
├── protocol.go      # Protocol errors
├── security.go      # Security errors
├── storage.go       # Storage errors
├── llm.go          # LLM errors
├── network.go      # Network errors
├── internal.go     # Internal errors
└── helpers.go      # Helper functions
```

---

## Implementation Order

1. **Phase 1**: Base error type and methods
   - Error struct
   - Core methods (Error, Unwrap, Is, As)
   - Helper functions (New, Wrap)

2. **Phase 2**: Error categories
   - Validation errors
   - Protocol errors
   - Security errors

3. **Phase 3**: Remaining errors
   - Storage errors
   - LLM errors
   - Network errors
   - Internal errors

4. **Phase 4**: Tests and documentation
   - Comprehensive test suite
   - Usage examples
   - Godoc comments

---

## Success Criteria

- [ ] Base Error type implemented
- [ ] All error categories defined
- [ ] Standard Go error interfaces implemented
- [ ] Helper functions for error creation and wrapping
- [ ] 90%+ test coverage
- [ ] All tests passing
- [ ] Godoc comments on all exported types
- [ ] Usage examples documented

---

## Dependencies

- Standard library: `errors`, `fmt`
- No external dependencies

---

## Next Steps

1. Implement base Error type with TDD
2. Add error categories
3. Write comprehensive tests
4. Achieve 90%+ coverage
5. Commit to feature branch

---

**Document Owner**: SAGE ADK Team
**Last Updated**: 2025-10-07 00:36:56
**Next Review**: After implementation
