# A2A Adapter Design Document

**Version**: 1.0
**Created**: 2025-10-07
**Author**: SAGE ADK Development Team

## Overview

This document describes the design for the A2A (Agent-to-Agent) protocol adapter, which wraps the `sage-a2a-go` library to provide A2A protocol support within the SAGE ADK framework.

## Design Principles

Based on AI agent development research:
- **Adapter Pattern**: Wrap sage-a2a-go without reimplementation
- **Progressive Disclosure**: Simple for common use, powerful when needed
- **Zero Overhead**: Minimal abstraction layer, direct passthrough where possible
- **Type Safety**: Convert between sage-adk types and sage-a2a-go types safely

## Architecture

### Type Conversion Strategy

The A2A adapter must convert between two type systems:

```
sage-adk/pkg/types  <-->  sage-a2a-go/protocol
     Message                  Message
     Part                     Part (TextPart, FilePart, DataPart)
     SecurityMetadata         (not used in A2A)
```

### Adapter Structure

```go
type A2AAdapter struct {
    client  *client.A2AClient    // sage-a2a-go client
    config  *config.A2AConfig    // A2A configuration from sage-adk
    mu      sync.RWMutex         // Thread-safe operations
}
```

## Implementation Plan

### Phase 1: Type Converters (Pure Functions)

Create converter functions between type systems:

```go
// Convert sage-adk Message to sage-a2a-go Message
func toA2AMessage(msg *types.Message) (a2a.Message, error)

// Convert sage-a2a-go Message to sage-adk Message
func fromA2AMessage(msg *a2a.Message) (*types.Message, error)

// Convert sage-adk Parts to sage-a2a-go Parts
func toA2AParts(parts []types.Part) ([]a2a.Part, error)

// Convert sage-a2a-go Parts to sage-adk Parts
func fromA2AParts(parts []a2a.Part) ([]types.Part, error)
```

### Phase 2: Adapter Implementation

Implement ProtocolAdapter interface:

```go
func NewA2AAdapter(config *config.A2AConfig) (*A2AAdapter, error) {
    client, err := client.NewA2AClient(config.ServerURL, ...)
    return &A2AAdapter{
        client: client,
        config: config,
    }, nil
}

func (a *A2AAdapter) Name() string {
    return "a2a"
}

func (a *A2AAdapter) SendMessage(ctx context.Context, msg *types.Message) error {
    a2aMsg, err := toA2AMessage(msg)
    params := a2a.SendMessageParams{
        Message: a2aMsg,
        RPCID:   a2a.GenerateRPCID(),
    }
    _, err = a.client.SendMessage(ctx, params)
    return err
}

func (a *A2AAdapter) ReceiveMessage(ctx context.Context) (*types.Message, error) {
    // A2A uses request-response model, not standalone receive
    return nil, errors.ErrNotSupported.WithMessage("A2A uses request-response model")
}

func (a *A2AAdapter) Verify(ctx context.Context, msg *types.Message) error {
    // A2A verification handled by sage-a2a-go client
    return nil
}

func (a *A2AAdapter) SupportsStreaming() bool {
    return true
}

func (a *A2AAdapter) Stream(ctx context.Context, fn protocol.StreamFunc) error {
    // Use sage-a2a-go streaming client
    resultChan, err := a.client.SendMessageStream(ctx, params)
    for event := range resultChan {
        // Convert event to string and call fn
        if err := fn(eventString); err != nil {
            return err
        }
    }
    return nil
}
```

### Phase 3: Testing Strategy

1. **Converter Tests**: Test type conversion independently
   - Valid conversions (round-trip)
   - Edge cases (nil values, empty arrays)
   - Error cases (invalid types)

2. **Adapter Tests**: Test adapter with mock client
   - SendMessage success/failure
   - Streaming success/failure
   - Configuration validation

3. **Integration Tests** (future): Test with real sage-a2a-go server

## Type Mapping

### Message Fields

| sage-adk (types.Message)  | sage-a2a-go (protocol.Message) |
|---------------------------|--------------------------------|
| MessageID                 | MessageID                      |
| Role                      | Role                           |
| Parts                     | Parts                          |
| ContextID                 | ContextID                      |
| Kind                      | Kind                           |
| Security                  | (ignore, not in A2A)           |

### Part Types

| sage-adk            | sage-a2a-go         | Notes                |
|---------------------|---------------------|----------------------|
| TextPart            | TextPart            | Direct mapping       |
| FilePart            | FilePart            | Handle FileUnion     |
| DataPart            | DataPart            | Direct mapping       |

### Part Fields

**TextPart**:
- `Kind`: "text" (both)
- `Text`: Direct mapping

**FilePart**:
- sage-adk: `File` interface (FileWithBytes, FileWithURI)
- sage-a2a-go: `File` FileUnion (FileWithBytes, FileWithURI)
- Conversion: Type assertion and wrapping

**DataPart**:
- `Kind`: "data" (both)
- `Data`: Direct mapping (both use `interface{}`)

## Error Handling

Convert sage-a2a-go errors to sage-adk error types:

```go
func convertError(err error) error {
    if err == nil {
        return nil
    }
    // Map specific a2a errors to sage-adk errors
    // Default: wrap in ErrInternal
    return errors.ErrInternal.Wrap(err)
}
```

## Configuration

A2A adapter requires:

```yaml
a2a:
  server_url: "http://localhost:8080/"  # Required
  timeout: 30s                          # Optional (default: no timeout)
  user_agent: "sage-adk/0.1.0"         # Optional
```

## Dependencies

- `github.com/sage-x-project/sage-a2a-go/client`: A2A client
- `github.com/sage-x-project/sage-a2a-go/protocol`: A2A types
- `github.com/sage-x-project/sage-adk/pkg/types`: SAGE ADK types
- `github.com/sage-x-project/sage-adk/pkg/errors`: SAGE ADK errors
- `github.com/sage-x-project/sage-adk/config`: SAGE ADK config

## Future Enhancements

1. **Task Support**: Implement task-based workflows (currently message-only)
2. **Push Notifications**: Support A2A push notification configuration
3. **Artifacts**: Support streaming artifacts
4. **History**: Support message history retrieval
5. **Connection Pooling**: Reuse HTTP connections efficiently

## References

- A2A Specification: https://github.com/google/A2A
- sage-a2a-go: `/sage-a2a-go/` directory
- Protocol Layer Design: `docs/design-20251007-024648-v1.0.md`
- AI Agent Research: `docs/analysis/` directory
