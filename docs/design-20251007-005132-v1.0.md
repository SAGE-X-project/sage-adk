# Configuration Management Design

**Version**: 1.0
**Created**: 2025-10-07 00:51:32
**Status**: Design Phase
**Target**: config/

---

## Overview

This document defines the configuration management system for SAGE ADK. The system must support:

1. **Multiple Sources**: YAML files, environment variables, programmatic configuration
2. **Hierarchical**: Nested configuration with dot notation
3. **Type-Safe**: Strong typing with validation
4. **Environment-Aware**: Development, staging, production profiles
5. **Hot Reload**: Configuration updates without restart (optional)

---

## Design Principles

### 1. Configuration Structure

```go
type Config struct {
    Agent    AgentConfig
    Server   ServerConfig
    Protocol ProtocolConfig
    A2A      A2AConfig
    SAGE     SAGEConfig
    LLM      LLMConfig
    Storage  StorageConfig
    Logging  LoggingConfig
    Metrics  MetricsConfig
}
```

### 2. Priority Order

Configuration sources in order of precedence (highest to lowest):
1. Programmatic configuration (explicit `Set` calls)
2. Environment variables
3. Configuration file (YAML)
4. Default values

### 3. Environment Variable Mapping

- Prefix: `ADK_`
- Nested keys: Use underscore (e.g., `ADK_AGENT_NAME`)
- Arrays: Use comma-separated values

---

## Configuration Types

### Agent Configuration

```go
type AgentConfig struct {
    ID          string
    Name        string
    Description string
    Version     string
}
```

### Server Configuration

```go
type ServerConfig struct {
    Host            string
    Port            int
    ReadTimeout     time.Duration
    WriteTimeout    time.Duration
    ShutdownTimeout time.Duration
}
```

### Protocol Configuration

```go
type ProtocolConfig struct {
    Mode              string  // "a2a", "sage", "auto"
    AutoDetect        bool
    DefaultProtocol   string
}
```

### A2A Configuration

```go
type A2AConfig struct {
    Enabled       bool
    Version       string
    TaskTimeout   time.Duration
}
```

### SAGE Configuration

```go
type SAGEConfig struct {
    Enabled           bool
    Network           string  // "ethereum", "kaia", "sepolia", etc.
    DID               string
    PrivateKeyPath    string
    CacheEnabled      bool
    CacheTTL          time.Duration
}
```

### LLM Configuration

```go
type LLMConfig struct {
    Provider        string  // "openai", "anthropic", "gemini"
    APIKey          string
    Model           string
    MaxTokens       int
    Temperature     float64
    Timeout         time.Duration
}
```

### Storage Configuration

```go
type StorageConfig struct {
    Type     string  // "memory", "redis", "postgres"
    Redis    RedisConfig
    Postgres PostgresConfig
}

type RedisConfig struct {
    Host     string
    Port     int
    Password string
    DB       int
}

type PostgresConfig struct {
    Host     string
    Port     int
    User     string
    Password string
    Database string
    SSLMode  string
}
```

### Logging Configuration

```go
type LoggingConfig struct {
    Level      string  // "debug", "info", "warn", "error"
    Format     string  // "json", "text"
    OutputPath string
}
```

### Metrics Configuration

```go
type MetricsConfig struct {
    Enabled bool
    Port    int
    Path    string
}
```

---

## Implementation

### Config Manager

```go
type Manager struct {
    config *Config
    viper  *viper.Viper
    mu     sync.RWMutex
}

// Load loads configuration from file and environment
func (m *Manager) Load(configPath string) error

// Get returns the current configuration (read-only)
func (m *Manager) Get() *Config

// Set updates configuration programmatically
func (m *Manager) Set(key string, value interface{}) error

// Reload reloads configuration from sources
func (m *Manager) Reload() error

// Validate validates the configuration
func (m *Manager) Validate() error
```

### Loading Configuration

```go
// NewManager creates a new configuration manager
func NewManager() *Manager

// LoadFromFile loads configuration from YAML file
func LoadFromFile(path string) (*Config, error)

// LoadFromEnv loads configuration from environment variables
func LoadFromEnv() (*Config, error)

// Load loads configuration from all sources
func Load(configPath string) (*Config, error)
```

### Default Configuration

```go
func DefaultConfig() *Config {
    return &Config{
        Agent: AgentConfig{
            Name:    "sage-agent",
            Version: "0.1.0",
        },
        Server: ServerConfig{
            Host:            "0.0.0.0",
            Port:            8080,
            ReadTimeout:     30 * time.Second,
            WriteTimeout:    30 * time.Second,
            ShutdownTimeout: 10 * time.Second,
        },
        Protocol: ProtocolConfig{
            Mode:            "auto",
            AutoDetect:      true,
            DefaultProtocol: "a2a",
        },
        // ... more defaults
    }
}
```

---

## Validation Rules

### Agent Validation
- Name must not be empty
- Version must follow semver format

### Server Validation
- Port must be between 1 and 65535
- Timeouts must be positive

### Protocol Validation
- Mode must be one of: "a2a", "sage", "auto"
- DefaultProtocol must be one of: "a2a", "sage"

### SAGE Validation
- If enabled, DID must be provided
- Network must be valid

### LLM Validation
- Provider must be one of: "openai", "anthropic", "gemini"
- APIKey must be provided
- MaxTokens must be positive

### Storage Validation
- Type must be one of: "memory", "redis", "postgres"
- If Redis, host and port must be provided
- If Postgres, all connection fields must be provided

---

## Usage Examples

### Loading from File

```go
config, err := config.Load("config.yaml")
if err != nil {
    log.Fatal(err)
}
```

### Using Manager

```go
manager := config.NewManager()
if err := manager.Load("config.yaml"); err != nil {
    log.Fatal(err)
}

cfg := manager.Get()
fmt.Printf("Agent: %s\n", cfg.Agent.Name)
```

### Environment Override

```bash
export ADK_AGENT_NAME="my-agent"
export ADK_SERVER_PORT=9090
export ADK_LLM_PROVIDER="openai"
export ADK_LLM_API_KEY="sk-..."
```

### Programmatic Configuration

```go
manager := config.NewManager()
manager.Set("agent.name", "custom-agent")
manager.Set("server.port", 8080)
```

---

## Testing Strategy

### Unit Tests

```go
func TestLoad_FromFile(t *testing.T)
func TestLoad_FromEnv(t *testing.T)
func TestLoad_Precedence(t *testing.T)
func TestValidate_Success(t *testing.T)
func TestValidate_Errors(t *testing.T)
func TestManager_Set(t *testing.T)
func TestManager_Get(t *testing.T)
```

### Coverage Goals

- 90%+ test coverage
- All validation rules tested
- All loading methods tested
- Precedence order verified

---

## File Organization

```
config/
├── doc.go          # Package documentation
├── config.go       # Main Config struct and types
├── config_test.go  # Config tests
├── manager.go      # Configuration manager
├── manager_test.go # Manager tests
├── loader.go       # Loading functions
├── loader_test.go  # Loader tests
├── validation.go   # Validation logic
├── validation_test.go  # Validation tests
└── defaults.go     # Default configuration
```

---

## Implementation Order

1. **Phase 1**: Configuration types
   - Define all config structs
   - Default configuration

2. **Phase 2**: Loading logic
   - File loading (YAML)
   - Environment loading
   - Precedence handling

3. **Phase 3**: Validation
   - Validation rules
   - Error messages

4. **Phase 4**: Manager
   - Config manager
   - Get/Set methods
   - Reload support

---

## Success Criteria

- [ ] All configuration types defined
- [ ] Loading from YAML files
- [ ] Loading from environment variables
- [ ] Correct precedence order
- [ ] Validation for all fields
- [ ] Configuration manager with Get/Set
- [ ] 90%+ test coverage
- [ ] All tests passing
- [ ] Godoc comments complete

---

## Dependencies

- `github.com/spf13/viper` - Configuration management
- Standard library: `time`, `sync`
- Internal: `pkg/errors` for error handling

---

**Document Owner**: SAGE ADK Team
**Last Updated**: 2025-10-07 00:51:32
**Next Review**: After implementation
